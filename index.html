<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="js/phaser.js"></script>
    </head>
<body>

<script type="text/javascript">
window.onload = function() {
    var game = new Phaser.Game(800, 800, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

    function preload() {
        game.load.tilemap("map", "assets/map.json", null, Phaser.Tilemap.TILED_JSON);
    }

    var navMeshLines = [];
    var wallRectangles = [];
    function create() {
        var map = game.add.tilemap("map");

        var navMeshLayer = getLayerByName(map, "nav mesh");
        navMeshLines = getPolygonObjectsAsLines(navMeshLayer);

        var wallLayer = getLayerByName(map, "walls");
        wallRectangles = getRectangleObjectAsPhaserRectangle(wallLayer);
    }

    var getLayerByName = function(map, layerName) {
        var objectLayers = map.objects;
        return (objectLayers.hasOwnProperty(layerName)) ? objectLayers[layerName] : null;
    }

    var getRectangleObjectAsPhaserRectangle = function(layer) {
        var rectangles = [];
        for (var i = 0; i < layer.length; i++) {
            var object = layer[i];
            var rect = new Phaser.Rectangle(object.x, object.y, object.width, object.height);

            rectangles.push(rect);
        }

        return rectangles;
    }

    var getPolygonObjectsAsLines = function(layer) {
        var lines = [];
        for (var i = 0; i < layer.length; i++) {
            var object = layer[i];

            var points = [];
            for (var poly = 0; poly < object.polygon.length; poly++) {
                points[poly] = [];

                var x = object.polygon[poly][0] + object.x;
                points[poly].push(x);

                var y = object.polygon[poly][1] + object.y;
                points[poly].push(y);
            }

            //when we have 2 points, draw a line. so get 1 pt, wait, get 2nd point, draw from 2nd to 1st. etc.
            for (var p = 0; p < points.length; p++) {
                if (p > 0) {
                    var line = new Phaser.Line(points[p][0], points[p][1], points[p-1][0], points[p-1][1]);
                    lines.push(line);
                }
                if ((p + 1) == points.length) { //if last point, draw line from last to first point
                    var line = new Phaser.Line(points[p][0], points[p][1], points[0][0], points[0][1]);
                    lines.push(line);
                }
            }
        }

        return lines;
    }

    function update() {

    }

    function render() {
        for (var i = 0; i < wallRectangles.length; i++) {
            game.debug.geom(wallRectangles[i], "#0066FF");
        }

        for (var i = 0; i < navMeshLines.length; i++) {
            game.debug.geom(navMeshLines[i], "#FF6600");
        }
    }

}
</script>

</body>
</html>